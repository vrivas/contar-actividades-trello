<!DOCTYPE html>
<html>
<head>
 
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">    <style>
      h1 {
        background-color: blue;
      }
    </style>
    <title>
        Análisis de desempeño en tableros Trello
    </title>
    <script>
        // variables globales
        var actions = null
        var members = null
        var actionsType = null
        var actionsTypeKeys = null
        var board = null
        var cards = null

        var fin = new Date("2025-04-19T23:55:00.0Z")
        var inicio = new Date("2021-03-23T00:00:00.0Z")

        function porcentaje( a,b ) {
            return ((a/b)*100).toFixed(2)+"%"
        }

        function fecha( f ) {
            return (new Date(f)).toLocaleString("es-ES")
        }
        function descargaDatos(callBackFn) {
            let sufijo=".json"
            let url=t_tablero.value+sufijo
            // url="https://trello.com/b/vKq2Qi0w.json"
            if( url.length<=sufijo.length ) return

            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {  
                    board= JSON.parse(JSON.stringify(data))
                    callBackFn()
                    return
                })
                .catch(function (err) {
                    // If an error occured, you will catch it here
                    console.log("OJO Error: " + err)
                });
        }

    </script>
    <script>

        // Escritura en elemento
        Object.prototype.html = function (texto) {
            this.innerHTML += texto
            return this
        }
        Object.prototype.cls = function () {
            this.innerHTML = ""
            return this
        }

        function nombreTablero() {
            sp_nombre_tablero.html(board.name)
        }

        function rellenaVectores() {
            actions_filtered = actions_all = board.actions
            if( fecha_inicio.value) {
                var inicio=new Date( fecha_inicio.value )
                inicio.setHours(0)
                inicio.setMinutes(0)
                inicio.setSeconds(0)
                inicio.setMilliseconds(0)
                actions_filtered = actions_all.filter(e => inicio <= new Date(e.date) )
            } 
            if( fecha_final.value) {
                var fin=new Date( fecha_final.value )
                fin.setHours(23)
                fin.setMinutes(59)
                fin.setSeconds(59)
                fin.setMilliseconds(999)            
                
                actions_filtered = actions_filtered.filter(e => new Date(e.date) <= fin)
            }
            members = board.members
            actionsType=agruparTiposDeAcciones( actions_filtered )
            actionsTypeKeys = Object.keys(actionsType).sort()
            cards = board.cards
        }

        function miembros() {
            members.forEach(e => dv_miembros.html("<li>" 
                + e.fullName 
                + ": "
                + e.id
                + "</li>\n"))
        }

        function numeroDeAcciones() {
            dv_numero_acciones.html("<li>Número de acciones totales: " + actions_all.length + "</li>\n")
            dv_numero_acciones.html("<li>Número de acciones filtradas: " + actions_filtered.length + "</li>\n")
        }

        function agruparTiposDeAcciones(act) {
            let actType = [];
            act.forEach(e => {
                if
                    (typeof actType[e.type] !== 'undefined') {
                    ++actType[e.type];
                } else {
                    actType[e.type] = 1
                }
            })
            return actType;
        }
        function tiposDeAcciones() {
            // Tipos de acciones
            actionsTypeKeys.forEach(e =>
                dv_tipo_acciones.html("<li>" + e + ": " 
                    + actionsType[e] 
                    + "</li>\n"))

        }

        function tarjetas() {
            // Tipos de acciones
            sorted_cards = cards.sort( (a,b)=>a.date-b.date);
            sorted_cards.forEach(e =>
                dv_tarjetas.html("<li>" + e.id + ": " + e.name + "</li>\n"))

        }


        function calcularAccionesPorMiembro( m ) {
            let susAcciones = actions_filtered.filter( e=>e.memberCreator.id==m.id );
            let suPorcentaje = porcentaje(susAcciones.length, actions_filtered.length)
            
            return {
                "acciones": susAcciones
                , "porcentaje": suPorcentaje
                , "nombre": m.fullName
                , "id": m.id
            }
        }

        function mostrarResumenAccionesPorMiembro( m ) {
            let dv=dv_resumen_acciones_por_miembro;
            let o = calcularAccionesPorMiembro( m )
            dv.innerHTML+="<li>"+o.nombre+": "+o.porcentaje+"</li>\n";
        }

        function mostrarAccionesPorMiembro( m ) {
            let dv=dv_acciones_por_miembro;
            let o = calcularAccionesPorMiembro( m )
            dv.innerHTML+="<h4>"+o.nombre+" "+o.porcentaje+" ("+o.id+")</h4>\n";
            dv.innerHTML+="\
                <p><strong>Acciones totales:</strong> "+o.acciones.length
                    +" ("+o.porcentaje+")\
                    </p>\
                    "    

            susTipos=agruparTiposDeAcciones( o.acciones )
            susLlaves = Object.keys(susTipos).sort()            
            susLlaves.forEach(e =>
                dv.innerHTML+="\
                        <li>" + e + ": "
                        + susTipos[e] 
                        + " (" + porcentaje(susTipos[e], actionsType[e])+ ")\
                        </li>\
                    "
            )
        }

        function mostrarResumenAccionesMiembros() {
            members.forEach(e => mostrarResumenAccionesPorMiembro(e))

        }
        function mostrarAccionesMiembros() {
            members.forEach(e => mostrarAccionesPorMiembro(e))

        }

        function old( a, prefix ) {
            prefix = prefix || ""
            return ( typeof a.data!=="undefined" 
                    && typeof a.data.old!=="undefined" )?(prefix+JSON.stringify(a.data.old)):""
        }

        function accionesPorTarjeta( c ) {
            let dv=dv_acciones_por_tarjeta;
            dv.innerHTML+="<h4>"+c.name+" ("+c.id+")</h4>\n";
            let susAcciones =actions_filtered
                            .filter( e=> typeof e.data!=="undefined" )
                            .filter( e=>typeof e.data.card!=="undefined")
                            .filter( e=>e.data.card.id==c.id )
                            .sort((a,b)=>(new Date(a.date)).getTime()-(new Date(b.date)).getTime())
            dv.innerHTML+="\
                <p><strong>Acciones totales:</strong> "+susAcciones.length
                    +" ("+porcentaje(susAcciones.length, actions_filtered.length)+ ")\
                    </p>\
                    "    
            
            susAcciones.forEach(e =>
                dv.innerHTML+="<li>" 
                            //+e.id+": "
                            + e.type +": "
                            +fecha( e.date )
                        + old( e, " / <b>Cambios:</b> " )
                        + "</li>\n"
            )
            
        }


        function accionesTarjetas() {
            cards.forEach(e => accionesPorTarjeta(e))
        }

        function asignaEventos() {
            t_tablero.onblur=function() {
                board=null                
                start()
            }
            t_tablero.onkeydown=function(event) {
                if(event.keyCode == 13) {
                   t_tablero.blur()
                }
            }
            fecha_inicio.onchange=
            fecha_final.onchange=function() {
                imprimeInformacionFiltrandoAccionesPorFechas()
            }
                        
        }

        function vaciaDivs() {
            let borrables=document.getElementsByClassName( "borrable")

            for( i=0; i<borrables.length; ++i ) {
                borrables[i].innerHTML=""
            }
        }

        function imprimeInformacionFiltrandoAccionesPorFechas() {
            rellenaVectores()
            vaciaDivs()
            nombreTablero()
            miembros()
            numeroDeAcciones()
            tiposDeAcciones()
            tarjetas()
            mostrarResumenAccionesMiembros()    
            mostrarAccionesMiembros();
            accionesTarjetas();            
        }
        function start() {
            if ( !board ) {
                descargaDatos( start )
                return
            } 
            imprimeInformacionFiltrandoAccionesPorFechas()     
        }
    </script>

</head>

<body>
    <h1 class="well well-lg well-victor">Análisis de accion en tableros Trello</h1>

    <h4>Url del JSON del tablero: <input type="text" id="t_tablero" value="https://trello.com/b/vKq2Qi0w"/>.json</h4>
    https://trello.com/b/OFvTEfcB

    <p>Fecha inicio: <input type="date" id="fecha_inicio"></p>
    <p>Fecha final: <input type="date" id="fecha_final"></p>

    <h2>Tablero: <span id="sp_nombre_tablero" class="borrable"></span></h2>

    <h3>Miembros</h3>
    <div id="dv_miembros" class="borrable"></div>

    


    <h3>Número de acciones</h3>
    <div id="dv_numero_acciones" class="borrable"></div>

    <h3>Tipos de acciones</h3>
    <div id="dv_tipo_acciones" class="borrable"></div>

    <h3>Tarjetas</h3>
    <div id="dv_tarjetas" class="borrable"></div>

    <h2>Acciones por miembro</h2>
    <div id="dv_resumen_acciones_por_miembro" class="borrable"></div>

    <h3>Detalle de acciones por miembro</h2>
    <div id="dv_acciones_por_miembro" class="borrable"></div>

    <h2>Acciones por tarjeta</h2>
    <div id="dv_acciones_por_tarjeta" class="borrable"></div>

    <div id="dv_consola" class="borrable"></div>
    <script>
        asignaEventos()
        start()
    </script>
</body>

<style>
  * {
      font-family: Arial, Helvetica, Sans;
  }
  body {
    color: black;
    background-color: white;
  }
  body.contraste {
    color: white;
    background-color: black;
  }
  input{
      border: 0pt;
      font-size: 1em;
      background-color: inherit;
      border-bottom: 1px solid #ddd;
      color: inherit;

  }
  input:hover {
      background-color: #ddd;
  }
  input:focus {
      background-color: #ddf;
      color: #229;
  }
  input[type="Submit"] {
      margin-right: 1em;
  }
  .rojo {
      background-color: #daa;
  }
  .transparente {
      background-color: inherit;
  }
  label {
      width: 22%;
      display: block;
      float: left;
      padding: 0pt;
      margin: 0pt;
  }
  h1 {
      font-size: 150%;
  }

  h3 {
      font-size: 120%;
  }

  body {
      margin: 10px;
  }

  select {
      font-size: 70%;
  }

  .well-victor{
      background: rgb(22, 105, 173);
      color: #fff;
  }

  #datos {
      margin-left: 3em;
      font-size: 80%;
  }


  .progress {
      height: 2em;
  }
  .progress-bar{

      padding-top: 0.25em;
      font-size: 120%;
  }

</style>
</html>